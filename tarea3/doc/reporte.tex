\documentclass {article}

\usepackage[spanish]{babel}
\usepackage [T1]{fontenc}
\usepackage [utf8]{inputenc}
\usepackage {graphicx}
\usepackage{color}
\usepackage{xcolor}
\usepackage{verbatim}
\usepackage{tabls}
\usepackage[space]{grffile}
\usepackage{url}
\usepackage{float}
\usepackage{listingsutf8}
\usepackage[justification=centering]{caption}
\usepackage{subcaption}
\usepackage{multirow}
\usepackage{apacite}

\lstset{language=C++,
  frame=single,
  basicstyle=\ttfamily\small,
  keywordstyle=\color{blue}\ttfamily,
  stringstyle=\color{red}\ttfamily,
  commentstyle=\color[rgb]{0,0.5,0}\ttfamily,
  morecomment=[l][\color{magenta}]{\#},
  literate=%
  {á}{{\'a}}1
  {í}{{\'i}}1
  {é}{{\'e}}1
  {ó}{{\'o}}1
  {ú}{{\'u}}1
  {ñ}{{\~n}}1
}


\begin {document}

\title{Tarea 3: Uso de Gem5}
\author{Daniel García Vaglio (B42781), Esteban Zamora Alvarado (B47769)}

\maketitle

\section{¿Qué es Gem5?}
\cite{opencv} %avoid compilation errors


\section{Escenarios de prueba}

\subsection{Instalación}
Como se indica en las instrucciones, para instalar el simulador se emplea una máquina virtual de
Virtual Box, en Ubuntu 16.04 LTS. En la figura %ref fig
se muestran las especificaciones utilizadas par la realización de la tarea.

 
Luego para instalar gem5, lo primero que se debe hacer es instalar las dependencias. Como muchas de
ellas se encuentran en los repositorios denominados “Universe”, es necesario verificar que esos
repositorios están agregados. En caso que no esté se debe agregar, en nuestro caso particular, sí estaba. Luego se instalan las dependencias:

\begin{lstlisting}
  cat -etc-apt-sources.list
  sudo apt-get install g++ python python-dev scons zlib1g-dev m4  python-pydot protobuf-compiler git
\end{lstlisting}
 
Luego es necesario clonar el repositorio y compilar el código fuente. 

\begin{lstlisting}
  mkdir ~/repos && cd ~/repos
  git clone https://github.com/gem5/gem5.git
  cd ~/repos/gem5
  scons build/ARM/gem5.opt -j5
\end{lstlisting}

Como se deben realizar simulaciones con un sistema completo, entonces se deben descargar las
imágenes que recomiendan los desarrolladores de Gem5. Para los siguientes comandos se supone que el
archivo con las imágenes ha sido descargado en ``~/Downloads/''. 

\begin{lstlisting}
  sudo mkdir /dist/m5/system
  sudo cp ~/Downloads/aarch-system-2014-10.tar.xz .
  sudo tar -xf aarch-system-2014-10.tar.xz
\end{lstlisting}

Una vez completados los pasos anteriores, el sistema está listo para correr simulaciones con Gem5.

\subsection{Escenario A}

\subsubsection{Emulación de Syscall}
Primero se trabaja con el modo de simulación de llamadas a sistema. Para esto se debe ejecutar gem5,
indicarle que se va a utilizar dicha configuración, y además se le proporciona el ejecutable que se
desea ejecutar en la simulación. Para este caso particular, se utiliza el mismo ``hello world'' que se
ofrece de ejemplo simple de prueba. Para eso se utiliza el siguiente comando:

%FIXME: break line
\begin{lstlisting}
  build/ARM/gem5.opt configs/example/se.py -c tests/test-progs/hello/bin/arm/linux/hello
\end{lstlisting}

El código de hello world se ofrece a continuación:

\begin{lstlisting}
  #include <stdio.h>
  int main(){
    printf("Hello world!");
  }
\end{lstlisting}

El resultado de la simulación se muestra en la figura %ref

\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\textwidth]{img/hello_se_gem5_arm.png}
  \caption{\label{fig:se_arm} Simulación SE de hello world en Gem5}
\end{figure}

\subsubsection{Simulación de sistema completo}
El primer paso es crear la imagen que se va a estar utilizando para la simulación. Se toma como base
una de las imágenes disponibles de los links de descarga: ``linux-aarch32-ael.img''. Se crea una
copia y se monta para poder editar la imagen. Cabe destacar que como esto es una imagen de un disco
completo, se debe indicar el inicio del mismo al montarlo.

\begin{lstlisting}
  cd /dist/m5/system
  cp linux-aarch32-ael.img my_image.img
  fsik -l my_image.img
  #start: 63, block size 512
  sudo mount -o loop,offset=32256 my_image.img /mnt
\end{lstlisting}

Una vez se tiene montada la imagen, se le agrega el ejecutable y se desmonta:
\begin{lstlisting}
  cd /mnt/bin
  sudp cp ~/repos/gem5/test/test-progs/hello/bin/arm/linux/hello .
  cd
  sudo umount /mnt
\end{lstlisting}

Para la simulación del sistema completo se utiliza la imagen que se creó anteriormente.
Las simulaciones de sistema completo no imprimen en la salida estándar, sino que se
debe realizar una conexión por telnet con la máquina simulada. Entonces primero, para poder ejecutar
la simulación se debe ejecutar el siguiente comando, desde la raíz de Gem5:

\begin{lstlisting}
  build/ARM/gem5.opt configs/example/fs.py --disk-image=/dist/m5/system/disk/my_image.img
\end{lstlisting}

Luego en otra terminal se ejecuta telnet para conectarse a ``localhost 3456''. Una vez realizada la 


\subsection{Escenario B}

\subsection{Escenario C}


\section{Conclusiones}


%----------------------
% Bibliografía
%----------------------

\bibliographystyle{apacite}
\bibliography{bibliografia}

\end{document}
